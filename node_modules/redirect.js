
var url = require('url')
var utils = require('../lib/utils')


function redirect (req, options) {
  req._redirect = true

  req.on('response', function (res) {
    var loc = location(res, options)

    if (loc) {
      req.emit('redirect', res)

      options.path = loc
      req.init(utils.filter(options))

      req._chunks.forEach(function (chunk) {
        req.write(chunk)
      })
      if (req._ended) {
        req.end()
      }
    }
    else {
      req._redirect = false
      req._chunks = []
      if (req._src) {
        req._src.resume()
      }
    }
  })
}

function location (res, options) {
  var location = res.headers.get('location')

  if (res.statusCode >= 300 && res.statusCode < 400 && location) {

    if (options.followAllRedirects) {
      return location
    }
    else if (options.followRedirects) {
      switch (req.method) {
        case 'PATCH':
        case 'PUT':
        case 'POST':
        case 'DELETE':
          // Do not follow redirects
          break
        default:
          return location
      }
    }
  }
  else if (res.statusCode === 401) {
    // Basic Auth
    // var authHeader = req._auth.onResponse(res)
    // if (authHeader) {
    //   req.setHeader('authorization', authHeader)
    //   return req.uri
    // }
  }
  return location
}

module.exports = redirect
