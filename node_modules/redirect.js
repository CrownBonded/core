
var url = require('url')
var utils = require('../lib/utils')


function redirect (req, options) {
  req._redirect = true

  req.on('pipe', function (src) {
    req._src = src
    req._src.on('data', function (chunk) {
      if (req._redirect) {
        req._chunk = chunk
        req._src.pause()
      }
    })
  })
  req.on('response', function (res) {
    var loc = location(res, options)

    if (loc) {
      options.path = loc
      req.emit('redirect')

      req.init(utils.filter(options))
      if (req._src) {
        req.write(req._chunk)
      } else {
        req.end()
      }
    }
    else {
      req._redirect = false
      if (req._src) {
        req._src.resume()
      }
    }
  })
}

function location (res, options) {
  var location = res.headers.get('location')

  if (res.statusCode >= 300 && res.statusCode < 400 && location) {

    if (options.followAllRedirects) {
      return location
    }
    else if (options.followRedirects) {
      switch (req.method) {
        case 'PATCH':
        case 'PUT':
        case 'POST':
        case 'DELETE':
          // Do not follow redirects
          break
        default:
          return location
      }
    }
  }
  else if (res.statusCode === 401) {
    // Basic Auth
    // var authHeader = req._auth.onResponse(res)
    // if (authHeader) {
    //   req.setHeader('authorization', authHeader)
    //   return req.uri
    // }
  }
  return location
}

module.exports = redirect
