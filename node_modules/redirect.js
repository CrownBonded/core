
var url = require('url')
var utils = require('../lib/utils')


function redirect (req, options) {
  req._redirect = true

  req.on('response', function (res) {
    var loc = location(res, options)

    if (loc) {
      req.emit('redirect', res)

      options.path = loc
      req.init(utils.filter(options))

      req._chunks.forEach(function (chunk) {
        req.write(chunk)
      })
      if (req._ended) {
        req.end()
      }
    }
    else {
      req._redirect = false
      req._chunks = []
      if (req._src) {
        req._src.resume()
      }
    }
  })
}

function location (res, options) {
  var location = res.headers.get('location')
    , redirect = (typeof options.redirect === 'object') ? redirect : {}

  if (res.statusCode >= 300 && res.statusCode < 400 && location) {
    if (redirect.all) {
      return location
    }
    else if (!/PATCH|PUT|POST|DELETE/.test(options.method)) {
      return location
    }
  }
  // basic auth
  else if (options.auth && res.statusCode === 401) {
    var auth = require('auth')
    auth(null, options, res)
    if (options.headers.get('authorization')) {
      return options.path
    }
  }
}

module.exports = redirect
