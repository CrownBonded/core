
var url = require('url')
var debug = require('debug')
  , chalk = require('chalk')

console.req = debug('req')
console.res = debug('res')
console.options = debug('options')

var g = chalk.green
  , y = chalk.yellow


function log (req) {
  req.on('request', function (req, options) {
    console.options('\n      %o', options)
    console.req(g(req.method) + ' ' + y(uri(req)) + '\n      %o', req._headers)
  })

  req.on('response', function (res) {
    var st = status(res.statusCode)
    console.res(
      st(res.statusCode + ' ' + res.statusMessage) + '\n      %o',
      JSON.parse(JSON.stringify(res.headers))
    )
  })

  req.on('redirect', function (res) {
    var st = status(res.statusCode)
    console.res(
      st(res.statusCode + ' ' + res.statusMessage) + '\n      %o',
      JSON.parse(JSON.stringify(res.headers))
    )
  })
}

function uri (req) {
  return url.format({
    protocol: req.agent.protocol,
    host: req._headers.host,
    pathname: req.path
  })
}

function status (code) {
  if (code >= 100 && code <= 199) {
    return chalk.white
  }
  else if (code >= 200 && code <= 299) {
    return chalk.green
  }
  else if (code >= 300 && code <= 399) {
    return chalk.yellow
  }
  else if (code >= 400 && code <= 499) {
    return chalk.red
  }
  else if (code >= 500 && code <= 599) {
    return chalk.red.bold
  }
}

module.exports = log
