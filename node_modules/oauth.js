'use strict'

var url = require('url')
var _oauth = require('request-oauth')


function oauth (req, options) {

  var form, contentType = options.headers.get('content-type')
  if (options.form || /^application\/x-www-form-urlencoded/.test(contentType)) {
    form = options.body.toString()
  }

  var result = _oauth({
    oauth: options.oauth, uri: options.uri, method: options.method,
    query: options.uri.query, form: form, body: options.body
  })

  if (result instanceof Error) {
    req.emit('error', result.error)
    return
  }

  var transport = options.oauth.transport_method || 'header'
  if (transport === 'header') {
    options.headers.set('authorization', result)
  }
  else if (transport === 'query') {
    var href = options.uri.href += result
    options.uri = url.parse(href)
    options.path = options.uri.path
  }
  else if (transport === 'body') {
    options.body += result
  }
}

module.exports = oauth
